using AbstractMqHelp;
using Demo;
using Microsoft.Extensions.DependencyInjection;
using Newtonsoft.Json;
using ProtoBuf;
using RabbitMqHelp;
using System;
using System.Collections.Generic;
using System.IO;
using System.Text;
using System.Threading;
using System.Threading.Tasks;

namespace TestRabbitMq
{
    public class MianController
    {
        private IServiceCollection _services;
        private IServiceProvider _serviceProvider;
        private IBar _bar;
        private IS _s;
        public MianController()
        {

        }
        public MianController(IBar bar,IS s)
        {
            //_services = services;
            //_serviceProvider = _services.BuildServiceProvider();
            _bar = bar;
            _s = s;
        }

        public void ActionOne()
        {
            _bar.MethodOne();
            _s.S1();
        }

        public void ActionTwo()
        {
            //using (var scope = _serviceProvider.CreateScope())
            //{
            //    var bar = scope.ServiceProvider.GetService<IBar>();
            _bar.MethodTwo();
            //}

        }

    }
    class Program
    {
        static void Main(string[] args)
        {

            Console.WriteLine("Hello RabbitMq!");

            {
                RabbitMqManagerHelp rabbitMqManagerHelp = new RabbitMqManagerHelp();
                for (int i = 0; i < 10; i++)
                {
                    Task.Run(()=> {
                        rabbitMqManagerHelp.CreateConnection();
                       
                    });
                }
                Thread.Sleep(30 * 1000);
                for (int i = 0; i < 10; i++)
                {
                    Task.Run(() =>
                    {
                        rabbitMqManagerHelp.CreateConnection();
                    });
                }
                Thread.Sleep(30 * 1000);
                for (int i = 0; i < 10; i++)
                {
                    Task.Run(() =>
                    {
                        rabbitMqManagerHelp.CreateConnection();
                    });
                }
                //Thread.Sleep(30 * 1000);
                Thread.Sleep(30 * 1000);
                rabbitMqManagerHelp.CreateModel();
                Console.ReadLine();
            }



            //{
            //    IServiceCollection services= new ServiceCollection(); ;
            //    services.AddSingleton<IPublisher, RabbitMQPublisher>();
            //    var service = services.BuildServiceProvider().GetService<IPublisher>();
            //    TestDi testDi = new TestDi(service);
            //    testDi.F1();
            //}
            //{

            //    IServiceCollection services = new ServiceCollection();
            //    services.AddScoped<IBar, Bar>();
            //    services.AddScoped<IS, S>();
            //    var service=services.BuildServiceProvider();
            //    var Bar = service.GetService<IBar>();
            //    var s = service.GetService<IS>();
            //    //Console.WriteLine(Bar);
            //    var controller = new MianController(Bar, s);
            //    controller.ActionOne();
            //    //controller.ActionTwo();

            //    Console.Read();
            //}

            //RabbitMq mq = new RabbitMq();

            ////mq.HelloWorldReceive("hello", (model, ea) =>
            ////{
            ////    var body = ea.Body.ToArray();
            ////    var message = Encoding.UTF8.GetString(body);
            ////    Console.WriteLine(" [x] Received {0}", message);
            ////});


            //for (int i = 0; i < 1000000; i++)
            //{
            //    mq.HelloWorldSend("hello", "hello world!");
            //}

            //mq.HelloWorldReceive("hello", (model, ea) =>
            //{
            //    var body = ea.Body.ToArray();
            //    var message = Encoding.UTF8.GetString(body);
            //    Console.WriteLine(" [x] Received {0}", message);
            //});

            //RabbitMq mq2 = new RabbitMq();
            //mq2.HelloWorldSend("hello", "hello world2!");
            //Console.ReadLine();
            {
                //RabbitMQProvider rabbitMQProvider = new RabbitMQProvider("localhost", 5672, "guest", "guest");
                //RabbitMQPublisher rabbitMQPublisher = new RabbitMQPublisher(rabbitMQProvider);
                //int count = 0;
                //List<Person> person = new List<Person>();
                //for (int i = 0; i < 1000; i++)
                //{
                //    person.Add(new Person { 
                //        Id = i,
                //    Name = $"肖志龙_{i}"
                //});
                //    //person.Id = i;
                //    //person.Name = $"肖志龙_{i}";
                //    //rabbitMQPublisher.Publish("jsonmsginfo", person);
                //    //Console.WriteLine(i);
                //    count++;
                //}
                //rabbitMQPublisher.Publish("jsonmsginfo", person);
                //Console.WriteLine(count);

                ////RabbitMQSubscriber rabbitMQSubscriber = new RabbitMQSubscriber(rabbitMQProvider);
                ////rabbitMQSubscriber.Subscribe("jsonmsginfo", "JsonQueueDemo1", msgBytes =>
                //// {
                ////     var result = MessageSerializerFactory.CreateMessageSerializerInstance().Deserialize<Person>(msgBytes);
                ////     Console.WriteLine(result);

                //// });

                //Console.ReadLine();

            }
            //{
            //    List<Account> lists = new List<Account>();
            //    for (int i = 0; i < 100; i++)
            //    {
            //        ulong j = (ulong)(i + 1);
            //        lists.Add(new Account
            //        {
            //            Id = j,
            //            Name = "肖志龙",
            //            Password = "1dfdf+++===sd3232xxddFFF"
            //        });
            //    }

            //    //Account account = new Account
            //    //{
            //    //    Id = 123,
            //    //    Name = "肖志龙",
            //    //    Password = "1dfdf+++===sd3232xxddFFF"
            //    //};
            //    //byte[] bytesssss=new byte[900];
            //    using (MemoryStream ms = new MemoryStream())
            //    {
            //        Serializer.Serialize<List<Account>>(ms, lists);
            //        var sss = ms.ToArray();
            //        Console.WriteLine(sss.Length);
            //        StringBuilder stringBuilder = new StringBuilder();
            //        foreach (var item in sss)
            //        {
            //            stringBuilder.Append(item);
            //        }
            //        Console.WriteLine(stringBuilder.ToString());
            //    }
            //    //using (MemoryStream ms = new MemoryStream(bytesssss))
            //    //{
            //    //    var result22222=Serializer.Deserialize<Account>(ms);

            //    //    Console.WriteLine(result22222.Password);
            //    //}
            //    var result = JsonConvert.SerializeObject(lists);
            //    var bytess = Encoding.UTF8.GetBytes(result);
            //    Console.WriteLine(bytess.Length);

            //    var result2 = Encoding.UTF8.GetString(bytess);

            //    Console.WriteLine(result2);
            //}

            //{
            //    var stringbytes = "1039811892321301502291911512331901532624491001021001024343436161611151005150515012012010010070707010398218923213015022919115123319015326244910010210010243434361616111510051505150120120100100707070103983189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039841892321301502291911512331901532624491001021001024343436161611151005150515012012010010070707010398518923213015022919115123319015326244910010210010243434361616111510051505150120120100100707070103986189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039871892321301502291911512331901532624491001021001024343436161611151005150515012012010010070707010398818923213015022919115123319015326244910010210010243434361616111510051505150120120100100707070103989189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039810189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039811189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039812189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039813189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039814189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039815189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039816189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039817189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039818189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039819189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039820189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039821189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039822189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039823189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039824189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039825189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039826189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039827189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039828189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039829189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039830189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039831189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039832189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039833189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039834189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039835189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039836189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039837189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039838189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039839189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039840189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039841189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039842189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039843189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039844189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039845189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039846189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039847189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039848189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039849189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039850189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039851189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039852189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039853189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039854189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039855189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039856189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039857189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039858189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039859189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039860189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039861189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039862189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039863189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039864189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039865189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039866189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039867189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039868189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039869189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039870189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039871189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039872189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039873189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039874189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039875189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039876189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039877189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039878189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039879189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039880189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039881189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039882189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039883189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039884189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039885189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039886189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039887189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039888189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039889189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039890189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039891189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039892189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039893189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039894189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039895189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039896189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039897189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039898189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039899189232130150229191151233190153262449100102100102434343616161115100515051501201201001007070701039810018923213015022919115123319015326244910010210010243434361616111510051505150120120100100707070";
            //    var bytes = Encoding.UTF8.GetBytes(stringbytes);
            //    var strngsss = Encoding.UTF8.GetString(bytes);
            //    Console.WriteLine(strngsss);
            //}
        }
    }


    public interface IBar
    {
        void MethodOne();

        void MethodTwo();
    }
    public class Bar : IBar
    {
        public void MethodOne()
        {
            Console.WriteLine("MethOne....");
        }

        public void MethodTwo()
        {
            Console.WriteLine("MethTwo....");
        }
    }

    public interface IS
    {
        void S1();
    }

    public class S : IS
    {
        public void S1()
        {
            Console.WriteLine("HELLO S!!!");
        }
    }
    [ProtoContract]
    class Person
    {
        [ProtoMember(1)]
        public int Id { get; set; }
        [ProtoMember(2)]
        public string Name { get; set; }
    }
}
